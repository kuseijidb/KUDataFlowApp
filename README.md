# KUDataFlowApp

## セットアップと起動方法

### 前提条件
- Node.js 18以上
- PostgreSQL（Supabaseを使用）
- VSCode（推奨）

### 初回セットアップ

1. **依存関係のインストール**
   ```bash
   npm install
   ```

2. **環境変数の設定**
   `.env` ファイルを作成し、以下を設定：
   ```
   DATABASE_URL="postgresql://..."
   DIRECT_URL="postgresql://..."
   ```

3. **データベースのマイグレーション**
   ```bash
   npx prisma migrate dev
   ```

4. **Prisma Clientの生成**
   ```bash
   npx prisma generate
   ```

### VSCodeでの起動方法（推奨）

#### 方法1: フル再起動（クリーンビルド）
1. VSCodeでプロジェクトを開く
2. `Ctrl+Shift+P` (または `Cmd+Shift+P`) でコマンドパレットを開く
3. `Tasks: Run Task` を選択
4. `Full Restart: Kill + Clean + Generate + Start` を選択

これにより、以下が自動で実行されます：
- 既存のNodeプロセスを終了
- ビルドキャッシュをクリア
- Prisma Clientを再生成
- 開発サーバーを起動

#### 方法2: クイック再起動
1. `Ctrl+Shift+P` でコマンドパレットを開く
2. `Tasks: Run Task` を選択
3. `Quick Restart: Kill + Start` を選択

#### 方法3: デバッグモードで起動
1. `F5` キーを押す
2. または、サイドバーの「実行とデバッグ」から起動設定を選択

### コマンドラインでの起動

```bash
# 開発サーバーの起動
npm run dev

# Prisma Studioの起動（データベースGUI）
npx prisma studio
```

### トラブルシューティング

#### エラー: "Cannot read properties of undefined (reading 'deleteMany')"
Prisma Clientのキャッシュが古い可能性があります。

**解決方法:**
1. VSCodeのタスク `Full Restart: Kill + Clean + Generate + Start` を実行
2. または、手動で以下を実行：
   ```bash
   # Windowsの場合
   taskkill /F /IM node.exe
   rd /S /Q .next
   rd /S /Q node_modules\.prisma
   rd /S /Q generated\prisma
   npx prisma generate
   npm run dev
   ```

#### ポートが使用中のエラー
Next.jsは自動的に別のポート（3001、3002など）を使用します。
ターミナルに表示されるURLを確認してください。

### 利用可能なVSCodeタスク

`.vscode/tasks.json` で定義されているタスク：
- `Kill Node Processes` - すべてのNodeプロセスを終了
- `Clean Build Cache` - ビルドキャッシュをクリア
- `Generate Prisma Client` - Prisma Clientを再生成
- `Start Dev Server` - 開発サーバーを起動
- `Full Restart: Kill + Clean + Generate + Start` - フル再起動
- `Quick Restart: Kill + Start` - クイック再起動
- `Prisma Studio` - Prisma Studio（DB GUI）を起動

## データ統合の3つの設計思想（アルゴリズムのパターン）

この課題は、政党レベルの詳細データから市区町村レベルの集計データを作成し、異なる選挙回（3013回と3023回）の結果を「JISコード」をキーに横並びで比較する、という二重の処理を含んでいます。

### パターン1 ~ 集計優先・分離統合モデル（ETL思想に基づくモジュール化）~

#### 設計思想

各ソースデータ（3013回と3023回）を完全に**独立したパイプライン**として扱い、それぞれを最終的な出力形式に近い形まで加工・整形（Transform）した後で、最後に結合（Load）するアプローチ。データウェアハウスの構築で一般的に用いられる、堅牢な手法です。

#### 処理のワークフロー

1. **分離処理**: 3013データと3023データを完全に分離し、それぞれに対して以下の処理を実行。  
   * **計算**: 投票率および政党ごとの相対得票率を算出。  
   * **整形（ピボット）**: 党派・会派等を列に展開し、相対得票率を値に格納（市区町村レベルへの粒度統一）。  
2. **最終統合**: 2つの整形済みテーブルをJISコードをキーにJOINし、最終結果とする。

#### **評価**

| 観点 | 評価 | 理由 |
| :---- | :---- | :---- |
| **保守性** | 高 | 各選挙回のロジックが独立しているため、片方の処理変更がもう一方に影響しない（疎結合）。 |
| **開発効率** | 低〜中 | 共通計算ロジック（例：投票率）を2回記述する必要がある。 |
| **実行効率** | 中 | 処理が分散するため、並列処理に適しており、結果として高速化が期待できる。 |
| **推奨シーン** | 処理ロジックの**独立性**や**再利用性**を重視する場合。 |  |

---

### パターン2 ~ 統合優先・一括処理モデル（UNION思想に基づく記述の最小化）~

#### 設計思想

まず全てのソースデータ（3013回と3023回）を**縦方向（行方向）に統合**し、その後に必要な計算や集計処理を**一括で**行うアプローチ。計算ロジックの重複を最小限に抑え、コードの一元管理を目指します。

#### 処理のワークフロー

1. **事前計算**: 各データに対して、政党別相対得票率の計算など、統合前に必要な共通処理を実行。  
2. **縦統合**: 3013データと3023データを選挙回フラグを付けてUNION ALLで結合し、巨大な中間テーブルを作成。  
3. **一括処理**: 統合されたテーブルに対して、JISコードと選挙回の**複合キー**を用いて以下の処理を一括実行。  
   * 投票率などの集計値の確定。  
   * **ピボット**: 党派・会派等と選挙回を組み合わせた新しい列として展開し、最終結果とする。

#### 評価

| 観点 | 評価 | 理由 |
| :---- | :---- | :---- |
| **保守性** | 中 | 共通ロジックの記述は1回で済むが、エラー発生時に巨大な中間テーブルを追跡する必要がある。 |
| **開発効率** | 高 | 共通ロジックの記述が最小限で済み、開発スピードが速い。 |
| **実行効率** | 中〜低 | 巨大な中間テーブルが生成されるため、メモリ消費量が増え、処理速度が低下する可能性がある。 |
| **推奨シーン** | **コード記述量**の最小化と、計算ロジックの**統一性**を最優先する場合。 |  |

---

### パターン3 ~ 差分抽出・多段階集計モデル（JOIN思想に基づく検証可能性）

#### 設計思想

異なる粒度の情報（市区町村一意の情報と政党別情報）を独立した「中間ビュー/テーブル」として抽出し、JOIN操作を多用して最終的に組み上げるアプローチ。複雑なデータ構造から特定の情報を抽出する際に、検証性を高めます。

#### 処理のワークフロー

1. **粒度別抽出**: 各選挙回から以下の2つの中間テーブルを生成。  
   * **基礎テーブル (T\_Base)**: JISコードをキーに、有権者数や投票率などの**一意な情報のみ**を集約・抽出。  
   * **政党テーブル (T\_Party)**: JISコードをキーに、相対得票率を計算し、党派・会派等でピボット展開したテーブル。  
2. **中間結合**: 3013回は T\_Base と T\_Party をJOIN、3023回も同様にJOINして、2つの中間集計結果を作成。  
3. **最終統合**: 2つの中間集計結果をJISコードをキーにJOINし、最終結果とする。

#### 評価

| 観点 | 評価 | 理由 |
| :---- | :---- | :---- |
| **保守性** | 中 | 各処理が細かくビューに分かれるため、ロジック変更時の影響範囲が局所的。 |
| **開発効率** | 低 | JOIN操作が多く、処理の記述が複雑になりがち。 |
| **検証性** | **最高** | 粒度別の中間テーブル（ビュー）を確認することで、計算が正しいかを段階的に検証できる。 |
| **推奨シーン** | 集計ロジックが複雑で、**計算過程の正確性**を厳しく検証する必要がある場合。 |  |

